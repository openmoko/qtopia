<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>Greenphone Integration Guide</title>
</head>
<body>
<table border="0" cellpadding="0" cellspacing="0" width="100%">
<tr>
<td align="left" valign="top" width="32"><img src="images/qpelogo.png" align="left" width="32" height="32" border="0" /></td>
<td width="1">&nbsp;&nbsp;</td><td class="postheader" valign="center"><a href="index.html"><font color="#004faf">Home</font></a>&nbsp;&middot; <a href="classes.html"><font color="#004faf">All&nbsp;Classes</font></a>&nbsp;&middot; <a href="annotated.html"><font color="#004faf">Annotated</font></a>&nbsp;&middot; <a href="functions.html"><font color="#004faf">Functions</font></a></td>
<td align="right" valign="top" width="230"><img src="images/trolltech-logo.png" align="right" width="203" height="32" border="0" /></td></tr></table><h1 align="center">Greenphone Integration Guide<br /><small></small></h1>
<a name="top"></a><ul><li><a href="#system-boot-and-shutdown-sequences">System Boot and Shutdown Sequences</a></li>
<ul><li><a href="#boot-sequence">Boot Sequence</a></li>
<li><a href="#shutdown-sequence">Shutdown Sequence</a></li>
</ul>
</ul>
<a name="system-boot-and-shutdown-sequences"></a>
<h2>System Boot and Shutdown Sequences</h2>
<a name="boot-sequence"></a>
<h3>Boot Sequence</h3>
<p>The following table lists the stages of the Greenphone boot process. It contains a description of the actions performed during each stage of the boot process and an image of what the user should see on the LCD screen during each stage.</p>
<p><table align="center" cellpadding="2" cellspacing="1" border="0">
<tr valign="top" bgcolor="#a2c511"><th>Boot Stage</th><th colspan="2">Description</th></tr>
<tr valign="top" bgcolor="#a2c511"><th>Power on</th><th colspan="2"></th></tr>
<tr valign="top" bgcolor="#f0f0f0"><td colspan="2">Hardware reset condition.</td><td><img src="images//ig_black_screen.gif" /></td></tr>
<tr valign="top" bgcolor="#a2c511"><th colspan="2">Initial Program Loader (IPL)</th><th></th></tr>
<tr valign="top" bgcolor="#e0e0e0"><td colspan="2">Immediately after system reset the System CPU executes code from the IPL area of the Disc-on-Chip device. The IPL partially initializes the Disc-on-Chip device and loads the Secondary Program Loader (SPL) into RAM and executes it.</td><td><img src="images//ig_black_screen.gif" /></td></tr>
<tr valign="top" bgcolor="#a2c511"><th colspan="2">Secondary Program Loader (SPL)</th><th></th></tr>
<tr valign="top" bgcolor="#f0f0f0"><td colspan="2">The SPL provides two facilities:<ol type="1">
<li>low-level flash interface</li>
<li>loading and executing the Linux kernel.</li>
</ol>
<p>After control is passed from the IPL to the SPL, the SPL initializes the hardware necessary to perform its functions including the:</p>
<ul>
<li>Disc-on-Chip</li>
<li>LCD screen</li>
<li>USB interface</li>
<li>serial console</li>
</ul>
<p>The bootloader splash screen is displayed and the SPL loads and executes either the flash application or the Linux kernel.</p>
<p>While the SPL is running the LCD contains the image to the right which is the first image displayed on the Greenphone LCD screen.</p>
</td><td><img src="images//ig_bootloader_splash.gif" /></td></tr>
<tr valign="top" bgcolor="#a2c511"><th colspan="2">Linux Kernel</th><th></th></tr>
<tr valign="top" bgcolor="#e0e0e0"><td colspan="2">The kernel initializes all hardware with built-in drivers and displays the kernel splash screen on the LCD screen.<p>The internal initial RAM disc is mounted and the Disc-on-Chip driver module is loaded. The initial RAM disc is unmounted. The kernel startup sequence continues until <tt>/sbin/init</tt> is executed in User Space and control of the boot sequence is passed over to it.</p>
</td><td><img src="images//ig_kernel_splash.gif" /></td></tr>
<tr valign="top" bgcolor="#a2c511"><th colspan="2">Init</th><th></th></tr>
<tr valign="top" bgcolor="#f0f0f0"><td colspan="3">The <tt>/sbin/init</tt> process controls the User Space startup sequence which is defined in the <tt>/etc/inittab</tt> file as follows:</td></tr>
<tr valign="top" bgcolor="#e0e0e0"><td colspan="2"><tt>/etc/rc.d/rc.modules boot</tt><p>Loads filesystem modules required to mount all internal filesystems and mini SD cards containing Qtopia updates.</p>
</td><td><img src="images//ig_loading_filesystem_modules.gif" /></td></tr>
<tr valign="top" bgcolor="#f0f0f0"><td colspan="2"><tt>/etc/rc.d/rc.filesystems</tt><p>Linux provides an interface into the kernel via the <tt>proc</tt> virtual filesystem. This <tt>proc</tt> virtual filesystem is mounted on <tt>/proc</tt>.</p>
<p>The Greenphone uses temporary file systems for storing data that does not need to be retained over reboots. Temporary filesystems are mounted and populated at this stage. The temporary filessystems used by the Greenphone include:</p>
<ul>
<li>tmpfs mounted on <tt>/dev</tt> and populated with the contents of <tt>/dev.tgz</tt></li>
<li>tmpfs mounted on <tt>/var</tt> and populated with the contents of <tt>/var.tgz</tt></li>
</ul>
</td><td><img src="images//ig_mounting_virtual_filesystems.gif" /></td></tr>
<tr valign="top" bgcolor="#e0e0e0"><td colspan="2"><tt>/etc/rc.d/rc.filesystems</tt><p>The Greenphone contains writeable file systems, which can get corrupted if the device is not shutdown correctly. All writeable filesystems on the device are checked for errors and automatically repaired, if possible.</p>
</td><td><img src="images//ig_checking_filesystems.gif" /></td></tr>
<tr valign="top" bgcolor="#f0f0f0"><td colspan="2"><tt>/etc/rc.d/rc.filesystems</tt><p>The internal storage of the Greenphone is divided into four block devices. The first block device <tt>/dev/tffsa</tt> is partitioned in two and contains the read-only root filesystem and Qtopia image. The three remaining block devices, <tt>/dev/tffsb</tt>, <tt>/dev/tffsc</tt> and <tt>/dev/tffsd</tt> are used for 3rd party software, system configuration data and user documents, respectively.</p>
<p>These block devices are mounted at the following paths:</p>
<ul>
<li><tt>/dev/tffsa1</tt> on <tt>/</tt></li>
<li><tt>/dev/tffsa2</tt> on <tt>/opt/Qtopia.rom</tt></li>
<li><tt>/dev/tffsb</tt> on <tt>/mnt/disk2</tt></li>
<li><tt>/dev/tffsc</tt> on <tt>/mnt/user</tt></li>
<li><tt>/dev/tffsd</tt> on <tt>/mnt/user_local</tt></li>
</ul>
</td><td><img src="images//ig_mounting_filesystems.gif" /></td></tr>
<tr valign="top" bgcolor="#e0e0e0"><td colspan="3"><tt>/etc/rc.d/rc.newrootfs</tt><p>Normally re-flashing the Greenphone will only update the kernel and the first block device. Only flashing the the first block device preserves user data during the re-flashing operation. Updates for the block devices that are not flashed are stored in the root filesystem in compressed form. The system detects if the following directory hierarchies need to be updated:</p>
<ul>
<li><tt>/mnt/user</tt></li>
<li><tt>/mnt/user/etc</tt></li>
<li><tt>/mnt/user/tools</tt></li>
<li><tt>/mnt/user_local</tt></li>
<li><tt>/mnt/disk2</tt></li>
<li><tt>/mnt/disk2/Qtopia</tt></li>
</ul>
</td></tr>
</table></p>
<p><table width="100%" align="center" cellpadding="2" cellspacing="1" border="0">
<tr valign="top" bgcolor="#f0f0f0"><td><img src="images//ig_rebuilding_filesystems.gif" /></td><td><img src="images//ig_rebuilding_mnt_user.gif" /></td><td><img src="images//ig_rebuilding_mnt_user_etc.gif" /></td></tr>
</table></p>
<p><table width="100%" align="center" cellpadding="2" cellspacing="1" border="0">
<tr valign="top" bgcolor="#f0f0f0"><td><img src="images//ig_rebuilding_mnt_user_tools.gif" /></td><td><img src="images//ig_rebuilding_mnt_user_local.gif" /></td><td><img src="images//ig_rebuilding_mnt_disk2.gif" /></td><td><img src="images//ig_rebuilding_mnt_disk2_qtopia.gif" /></td></tr>
</table></p>
<p><table width="100%" align="center" cellpadding="2" cellspacing="1" border="0">
<tr valign="top" bgcolor="#f0f0f0"><td></td><td><tt>/etc/rc.d/rc.modules</tt><p>The remaining kernel modules are loaded at this stage. This includes drivers for:</p>
<ul>
<li>Networking</li>
<li>USB Client</li>
<li>Multimedia</li>
<li>Power Management</li>
<li>Bluetooth</li>
<li>NFS</li>
</ul>
</td><td><img src="images//ig_loading_modules.gif" /></td></tr>
<tr valign="top" bgcolor="#e0e0e0"><td></td><td><tt>/etc/rc.d/rc.sysinit</tt><p>Miscellaneous initialization including:</p>
<ul>
<li>setting the system clock</li>
<li>bringing up the loopback interface</li>
<li>setting the hostname</li>
</ul>
</td><td><img src="images//ig_initializing_system.gif" /></td></tr>
<tr valign="top" bgcolor="#f0f0f0"><td></td><td><tt>/etc/rc.d/rc.lids start</tt><p>Qtopia builds with SXE enabled benefit from kernel level Mandatory Access Controls (MACs). The Greenphone uses the LIDS security framework to implement MACs. If the kernel has LIDS support and an SXE enabled Qtopia is detected, LIDS is initialized and enabled.</p>
</td><td><img src="images//ig_starting_lids.gif" /></td></tr>
<tr valign="top" bgcolor="#e0e0e0"><td></td><td><tt>/etc/rc.d/rc.services start</tt><p>Qtopia depends on some underlying services for certain functionality. These services include:</p>
<ul>
<li>Dbus</li>
<li>Bluez</li>
</ul>
<p>Additionally networking services are also started, include:</p>
<ul>
<li>telnet</li>
<li>ftp</li>
<li>ssh</li>
<li>samba</li>
</ul>
<p>The following services are started directly from the <tt>/sbin/init</tt> process and are automatically respawned if they terminate:</p>
<ul>
<li>atd</li>
<li>syslogd</li>
</ul>
</td><td><img src="images//ig_starting_services.gif" /></td></tr>
<tr valign="top" bgcolor="#f0f0f0"><td></td><td><tt>/mnt/user/etc/trolltech_startup.sh</tt><p>The Greenphone supports updating Qtopia via an image on a miniSD card. If a miniSD card is present it is mounted and checked for a valid image.</p>
</td><td><img src="images//ig_checking_for_qtopia_update.gif" /></td></tr>
<tr valign="top" bgcolor="#e0e0e0"><td></td><td><tt>/mnt/user/etc/trolltech_startup.sh</tt><p>The final stage of the startup process is to start Qtopia.</p>
</td><td><img src="images//ig_starting_qtopia.gif" /></td></tr>
<tr valign="top" bgcolor="#a2c511"><th colspan="2">Qtopia</th><th></th></tr>
<tr valign="top" bgcolor="#f0f0f0"><td></td><td colspan="2">Qtopia displays a battery charging screen if it detects that the user plugged in the wall charger or USB cable to initiate the boot sequence.<p>This screen is displayed until the user presses the <tt>Hangup</tt> key to continue loading Qtopia or unplugs the cable to power off the device. Once the Qtopia home screen is displayed the system has finished booting.</p>
</td></tr>
</table></p>
<p><table align="center" cellpadding="2" cellspacing="1" border="0">
<tr valign="top" bgcolor="#f0f0f0"><td><img src="images//ig_qtopia_charging.gif" /></td><td><img src="images//ig_qtopia_homescreen.gif" /></td></tr>
</table></p>
<a name="shutdown-sequence"></a>
<h3>Shutdown Sequence</h3>
<p>The following table lists the stages of the Greenphone shutdown process. The table contains a description of what actions are performed during each stage of the shutdown process and an image of what the user should see on the LCD screen during each stage.</p>
<p><table width="100%" align="center" cellpadding="2" cellspacing="1" border="0">
<tr valign="top" bgcolor="#a2c511"><th>Shutdown Stage</th><th colspan="2">Description</th></tr>
<tr valign="top" bgcolor="#a2c511"><th>Qtopia</th><th colspan="2"></th></tr>
<tr valign="top" bgcolor="#f0f0f0"><td></td><td><i>User initiated shutdown:</i> The user select 'Shutdown' or 'Reboot' from the shutdown dialog. Qtopia executes the <tt>shutdown</tt> program with the appropriate arguments.<p><i>System initiated shutdown:</i> Qtopia will automatically shutdown if it detects a critical power condition.</p>
</td><td><img src="images//ig_qtopia_shutdown_dialog.gif" /></td></tr>
<tr valign="top" bgcolor="#a2c511"><th>Shutdown</th><th colspan="2"></th></tr>
<tr valign="top" bgcolor="#e0e0e0"><td></td><td colspan="2"><tt>/mnt/user/tools/shutdown</tt><p>The <tt>Leaving Qtopia</tt> splash screen is displayed for user-initiated shutdowns. For system-initiated shutdowns an error message describing why the system is shutting down is displayed. The <tt>shutdown</tt> process signals <tt>/sbin/init</tt> to initiate system shutdown.</p>
</td></tr>
</table></p>
<p><table width="100%" align="center" cellpadding="2" cellspacing="1" border="0">
<tr valign="top" bgcolor="#f0f0f0"><td><img src="images//ig_leaving_qtopia.gif" /></td><td><img src="images//ig_shutdown_lowpower.gif" /></td><td><img src="images//ig_shutdown_unknown.gif" /></td></tr>
</table></p>
<p><table width="100%" align="center" cellpadding="2" cellspacing="1" border="0">
<tr valign="top" bgcolor="#a2c511"><th>Init</th><th colspan="2"></th></tr>
<tr valign="top" bgcolor="#f0f0f0"><td></td><td colspan="2">The <tt>/sbin/init</tt> process controls the User Space shutdown sequence which is defined in the <tt>/etc/inittab</tt> file as follows:<ul>
<li><tt>/etc/rc.d/rc.lids stop</tt>: If LIDS was enabled at boot, the system switches LIDS into the SHUTDOWN state.</li>
<li><tt>/etc/rc.d/rc.services stop</tt>: all services are stopped.</li>
<li><tt>/sbin/init</tt>: all remaining running processes are signaled to terminate, and then forceably killed. All filesystems are unmounted or re-mounted read only. The kernel is signaled to power off or reboot the device.</li>
</ul>
</td></tr>
</table></p>
<p><table width="100%" align="center" cellpadding="2" cellspacing="1" border="0">
<tr valign="top" bgcolor="#f0f0f0"><td><img src="images//ig_stopping_lids.gif" /></td><td><img src="images//ig_stopping_services.gif" /></td><td><img src="images//ig_shutting_down_system.gif" /></td></tr>
</table></p>
<p><table width="100%" align="center" cellpadding="2" cellspacing="1" border="0">
<tr valign="top" bgcolor="#a2c511"><th>Power off/Reboot</th><th colspan="2"></th></tr>
<tr valign="top" bgcolor="#f0f0f0"><td></td><td>The system is powered-off or reset.</td><td><img src="images//ig_black_screen.gif" /></td></tr>
</table></p>
<p /><address><hr /><div align="center">
<table width="100%" cellspacing="0" border="0"><tr class="address">
<td width="30%">Copyright &copy; 2007 <a href="trolltech.html">Trolltech</a></td>
<td width="40%" align="center"><a href="trademarks.html">Trademarks</a></td>
<td width="30%" align="right"><div align="right">Qtopia 4.2.2</div></td>
</tr></table></div></address></body>
</html>
