<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>Qtopia Phone Library</title>
<style type="text/css"><!--
h3.fn,span.fn { margin-left: 1cm; text-indent: -1cm; }
a:link { color: #004faf; text-decoration: none }
a:visited { color: #672967; text-decoration: none }
body { background: #ffffff; color: black; }
--></style>
</head>
<body>

<table border="0" cellpadding="0" cellspacing="0" width="100%">
<tr>
<td align="left" valign="top"><a href="index.html"><img height="27" width="472" src="dochead.png" border="0"></a><br>
<font face="Arial,Helvetica,Geneva,Swiss,SunSans-Regular" align="center" size=32>Qtopia</font>
   <a href="index.html">Home</a>
 - <a href="qtopiaclasses.html">Classes</a>
 - <a href="qtopiahierarchy.html">Hierachy</a>
 - <a href="qtopiaannotated.html">Annotated</a>
 - <a href="qtopiafunctions.html">Functions</a>
 - <a href="qtindex.html">Qt Embedded</a>
</td>
<td align="right" valign="top">
  <img height="100" width="100" src="qpelogo.png" align="top" border="0">
</td>
</tr>
</table><h1 align=center>Qtopia Phone Library</h1>


<p> 
<a name="top"></a>
<!-- toc -->
<ul>
<li><a href="#1"> Introduction
</a>
<li><a href="#2"> Basic architecture
</a>
<li><a href="#3"> Dialing a number
</a>
<li><a href="#4"> Receiving an incoming SMS message
</a>
<li><a href="#5"> Adding a new handler
</a>
<li><a href="#6"> AT control commands used by Qtopia Phone Edition
</a>
<ul>
<li><a href="#6-1"> General commands (GSM 07.07, section 5)
</a>
<li><a href="#6-2"> Call control commands (GSM 07.07, section 6)
</a>
<li><a href="#6-3"> Network service related commands (GSM 07.07, section 7)
</a>
<li><a href="#6-4"> Mobile equipment control and status commands (GSM 07.07, section 8)
</a>
<li><a href="#6-5"> SMS commands (GSM 07.05)
</a>
<li><a href="#6-6"> Other commands
</a>
<li><a href="#6-7"> Phone-specific commands
</a>
</ul>
</ul>
<!-- endtoc -->

<p> <h2> Introduction
</h2>
<a name="1"></a><p> This document describes the architecture of the "qtopiaphone" library,
which is used to access the phone hardware to make and receive calls,
send SMS messages, access the SIM card, and so on.
<p> <h2> Basic architecture
</h2>
<a name="2"></a><p> The basic architecture is demonstrated in the following diagram:
<p> <center><img src="phonelibrary.png" width="276" height="310"></center> 
<p> An application, such as the dialer, uses C++ APIs to access information
about a phone line, the phone book in the SIM card, or the SMS message
system.
<p> Requests are transmitted to the phone server, which co-ordinates access
to the phone functionality from multiple applications.  This allows the
dialer and the SMS messaging client to both access the phone hardware
at the same time.
<p> The phone server then passes the requests on to the device handler,
which communicates with the hardware device to effect the requests.
Responses and status messages are passed back in the reverse direction.
<p> Currently, we have implemented a device handler based on "AT" commands.
The actual device itself is accessed via a serial port.  This is the
recommended way to interface phone functionality with Qtopia Phone.
<p> If "AT" commands are not available, the backend handler can be replaced
with code that effects the requests in some other manner.
<p> In the remainder of this document, we will demonstrate how requests and
responses flow through the system with two examples: dialing a number, and
receiving an incoming SMS message.
<p> <h2> Dialing a number
</h2>
<a name="3"></a><p> When the application wishes to dial a phone number, it performs the following
actions:
<p> <ul>
<li> Create an instance of the "<tt>PhoneLine</tt>" class.
<li> Call the "<tt>PhoneLine::createCall</tt>" method to get an
instance of the "<tt>PhoneCall</tt>" class that represents
the call.
<li> Call the "<tt>PhoneCall::dial</tt>" method to dial the number.
<li> "<tt>PhoneCall::dial</tt>" then transmits the request to the
phone server.
</ul>
<p> There will normally be only one instance of the "<tt>PhoneLine</tt>"
class per application.  There may be multiple instances of
"<tt>PhoneCall</tt>" if there are calls on hold or a multi-party
conference call is in progress.
<p> The phone library will transmit the dial request to the phone server using
<a href="http://doc.trolltech.com/qtopia1.6/html/qcop.html">QCop</a>.  The
phone server will then take the following actions:
<p> <ul>
<li> Obtain an instance of "<tt>PhoneLineAt</tt>", which represents
the AT command handler for the phone line.
<li> Call the "<tt>PhoneLineAt::createCall</tt>" method to create
an instance of the "<tt>PhoneCallAt</tt>" class.
<li> Call the "<tt>PhoneCallAt::dial</tt>" method to dial the
number.
<li> "<tt>PhoneCallAt::dial</tt>" will then send the "<tt>ATD</tt>"
command to the phone device to effect the dial request.
</ul>
<p> As can be seen, the sequence of operations directly mirrors the sequence
in the application.  The only difference is the final step: the application
side sends the request to the phone server, and the handler side performs the
low-level device operations directly.
<p> If your device does not support AT commands, you would write new handler
classes, modelled on the structure of "<tt>PhoneLineAt</tt>" and
"<tt>PhoneCallAt</tt>".  The exact details of how your device effects
the dial command is beyond the scope of this document.
<p> <h2> Receiving an incoming SMS message
</h2>
<a name="4"></a><p> When the AT command handler starts up, it registers for new message
indications using the "<tt>AT+CNMI</tt>" command.  This causes the
phone device to send "<tt>+CMTI</tt>" indications whenever a new
message arrives at the device.
<p> In the code, "<tt>+CMTI</tt>" is detected by
"<tt>SMSRequestAt::notification</tt>", and causes the AT command
handler to initiate a message count check ("<tt>SMSRequestAt::check</tt>").
Once the check completes, the number of messages is transmitted to the
application via the "<tt>SMSRequestPrivate::messageCount</tt>" signal.
<p> An alternative device handler would similarly need to arrange for the
"<tt>SMSRequestPrivate::messageCount</tt>" signal to be emitted
when new messages arrive.
<p> This signal is broadcast on the "<tt>QPE/Phone</tt>" QCop channel.
Applications can listen on this channel to receive notification of
new messages.  More than one application can listen for new message
notifications, but only one (usually the mail client) should subsequently
retrieve the message contents.
<p> When the mail client receives the signal, it calls the
"<tt>SMSRequest::firstMessage</tt>" and
"<tt>SMSRequest::nextMessage</tt>" methods to retrieve the
SMS message contents from the incoming queue.  Each message is returned to
the application via the "<tt>SMSRequestPrivate::fetched</tt>"
signal.
<p> Finally, once the application has received the message, it will delete
it from the incoming queue using "<tt>SMSRequest::deleteMessage</tt>".
The application (usually the mail client) will save the message in
another location so that the message is never permanently lost
(the message store in the device is treated as a temporary buffer
in our system).
<p> Note: we always use signals to pass messages and status reports back to
the application rather than function returns.  This is because the entire
phone system is asynchronous: the information may not be available
when the request is made and so must be transmitted later.
<p> <h2> Adding a new handler
</h2>
<a name="5"></a><p> If you wish to add a new phone device handler, you should inherit the
class "<tt>PhoneLinePrivate</tt>" and override all of the functionality
that is specified therein.  The "<tt>PhoneLineAt</tt>" class can be
used as a guide to the necessary structure.
<p> You will also need to modify the "<tt>PhoneLinePrivate::create</tt>"
method to return an instance of your class instead of
"<tt>PhoneLineAt</tt>".
<p> <h2> AT control commands used by Qtopia Phone Edition
</h2>
<a name="6"></a><p> This following sections list the "AT" control commands that we expect the
device to support.  Most of them are from the <a href="gsm.html">GSM</a> specifications.
<p> The device may support more commands than are listed here.  For
example, some phones support both "<tt>AT+CGMI</tt>" and "<tt>AT+GMI</tt>" to get
the manufacturer name.  We only require "<tt>AT+CGMI</tt>" but there is
no harm in the device supporting both.
<p> In the future, we may need to additional commands from the GSM
specifications 07.05 and 07.07, so we recommend that all device
manufacturers fully comply with those specifications.
<p> <h3> General commands (GSM 07.07, section 5)
</h3>
<a name="6-1"></a><p> <center><table cellpadding="4" cellspacing="2" border="0">
<tr bgcolor="#a2c511"> <th valign="top">Command <th valign="top">Description
<tr bgcolor="#f0f0f0">
<td valign="top"><tt>AT+CGMI</tt>
<td valign="top">Identify manufacturer
<tr bgcolor="#d0d0d0">
<td valign="top"><tt>AT+CGMM</tt>
<td valign="top">Identify model
<tr bgcolor="#f0f0f0">
<td valign="top"><tt>AT+CGMR</tt>
<td valign="top">Identify revision
<tr bgcolor="#d0d0d0">
<td valign="top"><tt>AT+CGSN</tt>
<td valign="top">Identify serial number (of device, not SIM card)
<tr bgcolor="#f0f0f0">
<td valign="top"><tt>AT+CSCS</tt>
<td valign="top">Select character set
</table></center>
<p> <h3> Call control commands (<a href="gsm.html">GSM</a> 07.07, section 6)
</h3>
<a name="6-2"></a><p> <center><table cellpadding="4" cellspacing="2" border="0">
<tr bgcolor="#a2c511"> <th valign="top">Command <th valign="top">Description
<tr bgcolor="#d0d0d0">
<td valign="top"><tt>ATDnnn;</tt>
<td valign="top">Dial "nnn" in voice mode.
<tr bgcolor="#f0f0f0">
<td valign="top"><tt>ATH</tt>
<td valign="top">Hangup the current call.
<tr bgcolor="#d0d0d0">
<td valign="top"><tt>ATA</tt>
<td valign="top">Answer an incoming call.
</table></center>
<p> Note: when the "<tt>ATD</tt>" command is used with a trailing ';', it must
immediately return to command mode after processing the command.
Some phones have been known to wait until the other party answers
the call, or busy is detected, before returning to command mode.
Such phones are not compliant with the GSM specification and we
will not be supporting them.
<p> The GSM specification allows "<tt>ATD</tt>" to be used in a special mode
for dialing directly from phone books.  We do not need this mode
as we implement our own algorithm for converting phone book entries
into numbers.
<p> It is important that "<tt>ATD</tt>" recognise numbers starting with "<tt>+</tt>"
as international, and all other numbers as being local.
<p> <h3> Network service related commands (<a href="gsm.html">GSM</a> 07.07, section 7)
</h3>
<a name="6-3"></a><p> <center><table cellpadding="4" cellspacing="2" border="0">
<tr bgcolor="#a2c511"> <th valign="top">Command <th valign="top">Description
<tr bgcolor="#f0f0f0">
<td valign="top"><tt>AT+CNUM</tt>
<td valign="top">Subscriber number
<tr bgcolor="#d0d0d0">
<td valign="top"><tt>AT+CREG</tt>
<td valign="top">Network registration
<tr bgcolor="#f0f0f0">
<td valign="top"><tt>AT+COPS</tt>
<td valign="top">Operator selection
<tr bgcolor="#d0d0d0">
<td valign="top"><tt>AT+CLIP</tt>
<td valign="top">Enable caller line identification
<tr bgcolor="#f0f0f0">
<td valign="top"><tt>AT+CLIR</tt>
<td valign="top">Caller ID restriction
<tr bgcolor="#d0d0d0">
<td valign="top"><tt>AT+CCFC</tt>
<td valign="top">Call forwarding number and conditions
<tr bgcolor="#f0f0f0">
<td valign="top"><tt>AT+CCWA</tt>
<td valign="top">Call waiting
<tr bgcolor="#d0d0d0">
<td valign="top"><tt>AT+CHLD</tt>
<td valign="top">Call hold and multiparty
<tr bgcolor="#f0f0f0">
<td valign="top"><tt>AT+CTFR</tt>
<td valign="top">Call transfer
<tr bgcolor="#d0d0d0">
<td valign="top"><tt>AT+CAOC</tt>
<td valign="top">Advice of charge
</table></center>
<p> <h3> Mobile equipment control and status commands (<a href="gsm.html">GSM</a> 07.07, section 8)
</h3>
<a name="6-4"></a><p> <center><table cellpadding="4" cellspacing="2" border="0">
<tr bgcolor="#a2c511"> <th valign="top">Command <th valign="top">Description
<tr bgcolor="#f0f0f0">
<td valign="top"><tt>AT+CPAS</tt>
<td valign="top">Phone activity status
<tr bgcolor="#d0d0d0">
<td valign="top"><tt>AT+CBC</tt>
<td valign="top">Battery charge
<tr bgcolor="#f0f0f0">
<td valign="top"><tt>AT+CSQ</tt>
<td valign="top">Signal quality
<tr bgcolor="#d0d0d0">
<td valign="top"><tt>AT+CPBS</tt>
<td valign="top">Select phonebook memory storage
<tr bgcolor="#f0f0f0">
<td valign="top"><tt>AT+CPBR</tt>
<td valign="top">Read phonebook entries
<tr bgcolor="#d0d0d0">
<td valign="top"><tt>AT+CPBF</tt>
<td valign="top">Find phonebook entries
<tr bgcolor="#f0f0f0">
<td valign="top"><tt>AT+CPBW</tt>
<td valign="top">Write phonebook entries
</table></center>
<p> The phonebook commands are intended for accessing phone books stored
on SIM cards.  The Qtopia Phone software has its own mechanisms for
managing phone books that are stored in the phone's memory.
<p> <h3> SMS commands (<a href="gsm.html">GSM</a> 07.05)
</h3>
<a name="6-5"></a><p> <center><table cellpadding="4" cellspacing="2" border="0">
<tr bgcolor="#a2c511"> <th valign="top">Command <th valign="top">Description
<tr bgcolor="#d0d0d0">
<td valign="top"><tt>AT+CPMS</tt>
<td valign="top">Preferred message storage
<tr bgcolor="#f0f0f0">
<td valign="top"><tt>AT+CMGF</tt>
<td valign="top">Message format (we use format 0: PDU)
<tr bgcolor="#d0d0d0">
<td valign="top"><tt>AT+CSCA</tt>
<td valign="top">Service centre address
<tr bgcolor="#f0f0f0">
<td valign="top"><tt>AT+CNMI</tt>
<td valign="top">Enable new message indications
<tr bgcolor="#d0d0d0">
<td valign="top"><tt>AT+CMGL</tt>
<td valign="top">List messages
<tr bgcolor="#f0f0f0">
<td valign="top"><tt>AT+CMGR</tt>
<td valign="top">Read message
<tr bgcolor="#d0d0d0">
<td valign="top"><tt>AT+CMGS</tt>
<td valign="top">Send message
<tr bgcolor="#f0f0f0">
<td valign="top"><tt>AT+CMGD</tt>
<td valign="top">Delete message
<tr bgcolor="#d0d0d0">
<td valign="top"><tt>+CMTI</tt>
<td valign="top">Notification of SMS message delivery.
<tr bgcolor="#f0f0f0">
<td valign="top"><tt>+CBMI</tt>
<td valign="top">Notification of a cell broadcast message.
<tr bgcolor="#d0d0d0">
<td valign="top"><tt>+CDSI</tt>
<td valign="top">Notification of an SMS status report message.
</table></center>
<p> We assume that incoming SMS messages are stored into a temporary
storage area on the device from which our software will retrieve
the messages using the "<tt>AT+CMGL</tt>" and "<tt>AT+CMGR</tt>" commands.
<p> <h3> Other commands
</h3>
<a name="6-6"></a><p> <center><table cellpadding="4" cellspacing="2" border="0">
<tr bgcolor="#a2c511"> <th valign="top">Command <th valign="top">Description
<tr bgcolor="#f0f0f0">
<td valign="top"><tt>AT+VTS</tt>
<td valign="top">DTMF and tone generation (<a href="gsm.html">GSM</a> 07.07, Appendix C)
<tr bgcolor="#d0d0d0">
<td valign="top"><tt>AT+CVIB</tt>
<td valign="top">Select vibrate mode
<tr bgcolor="#f0f0f0">
<td valign="top"><tt>AT+CPUC</tt>
<td valign="top">Price per unit
<tr bgcolor="#d0d0d0">
<td valign="top"><tt>AT+CIMI</tt>
<td valign="top">SIM identity
<tr bgcolor="#f0f0f0">
<td valign="top"><tt>AT+CHSC</tt>
<td valign="top">Get phone status (only needed if AT+CPAS is not available)
<tr bgcolor="#d0d0d0">
<td valign="top"><tt>AT+CLCC</tt>
<td valign="top">List active calls
</table></center>
<p> <h3> Phone-specific commands
</h3>
<a name="6-7"></a><p> The GSM specification is lacking some functionality that we require
to round out the feature set.  The most important of these is "call
monitoring".  When an outgoing dial request is made, we need some
way to detect when the other party accepts the call, if it rejected
due to the other party being busy, or some other failure.
<p> Ericsson phones have a "<tt>AT*ECAM</tt>" command that is used to turn on
supplementary call monitoring events: every time a call's status
changes, the phone emits a "<tt>*ECAV</tt>" message with the details.
We recommend that device manufacturers provide these commands,
or something very similar to them.
<p> <center><table cellpadding="4" cellspacing="2" border="0">
<tr bgcolor="#a2c511"> <th valign="top">Command <th valign="top">Description
<tr bgcolor="#f0f0f0">
<td valign="top"><tt>AT*ECAM</tt>
<td valign="top">Turn on call monitoring
<tr bgcolor="#d0d0d0">
<td valign="top"><tt>AT*ESIL</tt>
<td valign="top">Select silent mode
<tr bgcolor="#f0f0f0">
<td valign="top"><tt>*ECAV</tt>
<td valign="top">Unsolicited response for <tt>AT*ECAM</tt>
</table></center>
<p> 
<!-- eof -->
<p><address><hr><div align="center">
<table width="100%" cellspacing="0" border="0">
<tr>
<td>Copyright &copy; 2001-2005 Trolltech
<td><a href="http://www.trolltech.com/trademarks.html">Trademarks</a>
<td align="right"><div align="right">Qtopia version 2.1.1</div>
</table></div></address></body>
</html>
