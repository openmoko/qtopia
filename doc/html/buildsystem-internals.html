<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>Build System Internals</title>
</head>
<body>
<table border="0" cellpadding="0" cellspacing="0" width="100%">
<tr>
<td align="left" valign="top" width="32"><img src="images/qpelogo.png" align="left" width="32" height="32" border="0" /></td>
<td width="1">&nbsp;&nbsp;</td><td class="postheader" valign="center"><a href="index.html"><font color="#004faf">Home</font></a>&nbsp;&middot; <a href="classes.html"><font color="#004faf">All&nbsp;Classes</font></a>&nbsp;&middot; <a href="annotated.html"><font color="#004faf">Annotated</font></a>&nbsp;&middot; <a href="functions.html"><font color="#004faf">Functions</font></a></td>
<td align="right" valign="top" width="230"><img src="images/trolltech-logo.png" align="right" width="203" height="32" border="0" /></td></tr></table><h1 align="center">Build System Internals<br /><small></small></h1>
<p>This document is designed for people who need to extend or modify the build system. If you are looking for information about using the build system (including writing <tt>.pro</tt> files) refer to: <a href="buildsystem-user-guide.html">Build System User Guide</a> and <a href="buildsystem-reference.html">Build System Reference</a>.</p>
<ul><li><a href="#environment-variables">Environment Variables</a></li>
<li><a href="#build-steps">Build Steps</a></li>
<li><a href="#features">Features</a></li>
<li><a href="#install-prefixes">Install Prefixes</a></li>
<li><a href="#debugging-qmake">Debugging qmake</a></li>
<li><a href="#finding-files-directories-and-paths">Finding Files, Directories and Paths</a></li>
<li><a href="#style">Style</a></li>
<li><a href="#processing-order">Processing Order</a></li>
<li><a href="#project-roots">Project Roots</a></li>
<li><a href="#building-qt-qtopia-core">Building Qt/Qtopia Core</a></li>
<li><a href="#command-redirection">Command Redirection</a></li>
<li><a href="#how-do-i">How Do I ...</a></li>
<ul><li><a href="#add-a-custom-compiler">... add a custom compiler?</a></li>
<li><a href="#use-install-rules-at-other-times">... use install rules at other times?</a></li>
<li><a href="#run-some-commands-before-the-target-is-built">... run some commands before the target is built?</a></li>
<li><a href="#run-some-commands-after-the-target-is-built">... run some commands after the target is built?</a></li>
<li><a href="#make-my-project-get-processed-last">... make my project get processed last?</a></li>
</ul>
</ul>
<a name="environment-variables"></a>
<h2>Environment Variables</h2>
<p>The <a href="buildsystem-user-guide.html#what-has-changed">User Guide</a> states that environment variables are not required, however, that is not strictly correct. The build system causes the environment variables to be set appropriately when building and the <tt>configure</tt>, <tt>qtopiamake</tt> and <tt>Makefile</tt> scripts handle this for you. However, there are various scripts that cannot be run without environment variables set. If they are run from one of the scritps above, they will be fine but manual running will cause problems.</p>
<p>The following variable is expected by <tt>configure</tt>:</p>
<ul>
<li><tt>QPEDIR</tt><ul>
<li>Set it to the location of the build tree.</li>
<li>Unlike previous versions of Qtopia, <tt>QPEDIR</tt> can no longer override <tt>PWD</tt> to set the location of the build tree.</li>
<li>You can leave <tt>QPEDIR</tt> unset when you run <tt>configure</tt>, <tt>qtopiamake</tt> or <tt>make</tt>.</li>
<li>A future version of Qtopia will not use <tt>QPEDIR</tt>.</li>
</ul>
</li>
</ul>
<p>The following variables can be defined if required:</p>
<ul>
<li><tt>QTOPIA_DEPOT_PATH</tt><ul>
<li>Set it to the location of the Qtopia source tree.</li>
</ul>
</li>
</ul>
<p>The following table displays the variables that are set by <tt>configure</tt> and <tt>Makefile</tt>:</p>
<p><table align="center" cellpadding="2" cellspacing="1" border="0">
<tr valign="top" bgcolor="#a2c511"><th>Variable</th><th>Description</th></tr>
<tr valign="top" bgcolor="#f0f0f0"><td><tt>QMAKEFEATURES</tt></td><td><ul>
<li>Set to <tt>$PROJECT_ROOT/features:$QTOPIA_DEPOT_PATH/src/build</tt>.</li>
</ul>
</td></tr>
<tr valign="top" bgcolor="#e0e0e0"><td><tt>QTDIR</tt></td><td><ul>
<li>Set to <tt>$QPEDIR/qtopiacore/host</tt> for projects built for the host machine.</li>
<li>Set to <tt>$QPEDIR/qtopiacore/target</tt> for projects built for the target machine.</li>
</ul>
</td></tr>
<tr valign="top" bgcolor="#f0f0f0"><td><tt>PREFIX</tt></td><td><ul>
<li>Set to <tt>$QPEDIR/image/Qtopia</tt>.</li>
</ul>
</td></tr>
<tr valign="top" bgcolor="#e0e0e0"><td><tt>DPREFIX</tt></td><td><ul>
<li>Set to <tt>$QPEDIR/dimage/Qtopia</tt>.</li>
</ul>
</td></tr>
</table></p>
<p>The following table describes the variables that <tt>Makefile</tt> allows you to override:</p>
<p><table align="center" cellpadding="2" cellspacing="1" border="0">
<tr valign="top" bgcolor="#a2c511"><th>Variable</th><th>Description</th></tr>
<tr valign="top" bgcolor="#f0f0f0"><td><tt>PREFIX</tt></td><td>Change where Qtopia is installed to.</td></tr>
<tr valign="top" bgcolor="#e0e0e0"><td><tt>DPREFIX</tt></td><td>Change where Qtopia Desktop is installed to.</td></tr>
<tr valign="top" bgcolor="#f0f0f0"><td><tt>D</tt></td><td>See <a href="#debugging-qmake">Debugging qmake</a> for details.</td></tr>
</table></p>
<a name="build-steps"></a>
<h2>Build Steps</h2>
<ul>
<li><tt>configure</tt><ul>
<li>Configure Qt and Qtopia Core.</li>
<li>Create <tt>$QPEDIR/src/config.pri</tt> based on the options passed (and guessed/detected)</li>
<li>Prepare the build tree (eg. symlink files from the source tree)</li>
<li>Create a Makefile for every .pro file (mirrored into the source tree for depot hopping)</li>
<li>Create $QPEDIR/include and ensure libs have been processed (make syncqtopia)</li>
<li>Set up the project roots<ul>
<li>$QPEDIR/src - Qtopia</li>
<li>$QPEDIR/src/qtopiadesktop - Qtopia Desktop</li>
<li>$QPEDIR/etc/themes - Themes</li>
<li>$QPEDIR/src/plugins/designer - Designer plugins</li>
</ul>
</li>
</ul>
</li>
<li><tt>Makefile</tt><ul>
<li>Perform depot hopping</li>
<li>Set up environment/overrides/etc.</li>
<li>Ensure Makefile.target is up-to-date</li>
<li>Run Makefile.target (the file qmake generates)</li>
</ul>
</li>
<li><tt>.qmake.cache</tt><ul>
<li>There's one of these for each of the project roots.</li>
<li>Nothing much is done in this file. It exists because qmake will include it automatically.</li>
<li>include <tt>tree_config.pri</tt></li>
</ul>
</li>
<li><tt>tree_config.pri</tt><ul>
<li>There is one of these for each of the project roots.</li>
<li>Set up config values.</li>
<li>Add project keywords suitable for this part of the tree.</li>
</ul>
</li>
<li><tt>default_pre.prf</tt><ul>
<li>This file is guaranteed to be loaded before the main project file</li>
<li>Load <tt>functions.prf</tt></li>
<li>Load <tt>config.prf</tt></li>
</ul>
</li>
<li><tt>functions.prf</tt><ul>
<li>Set up custom functions</li>
<li>define the <tt>qtopia_project()</tt> function</li>
</ul>
</li>
<li>config.prf<ul>
<li>Load <tt>config.pri</tt></li>
<li>Set up static config</li>
<li>load <tt>projects.pri</tt></li>
</ul>
</li>
<li><tt>last_minute_config.prf</tt><ul>
<li>This is the last chance to set config before the <tt>.pro</tt> file is processed.</li>
<li>It is loaded from inside the <tt>qtopia_project()</tt> macro so scoping rules apply, that is you must <tt>export()</tt> variables to refer to them later.</li>
</ul>
</li>
<li><tt>[project].pro</tt><ul>
<li>This is the actual <tt>.pro</tt> file for the project</li>
<li><tt>qtopia_project()</tt> <b>must</b> be called or you'll get an error</li>
</ul>
</li>
<li><tt>qtopia_project()</tt><ul>
<li>Set up defaults and configure build system for the type of project being built</li>
</ul>
</li>
<li><tt>projects.pri</tt><ul>
<li>Set up the <tt>PROJECTS</tt> variable</li>
<li>See <a href="buildsystem-user-guide.html#deciding-what-to-build">Deciding What To Build</a> for details.</li>
<li>All applications that are applicable to a particular edition are enabled. The build system handles missing dependencies.</li>
</ul>
</li>
<li><tt>default_post.prf</tt><ul>
<li>Ensure the order of <tt>CONFIG</tt> variables is correct.(some features should be loaded early, others should be late)</li>
</ul>
</li>
</ul>
<p>The rest of the feature files are described below since they are not all loaded for any given project.</p>
<a name="features"></a>
<h2>Features</h2>
<p>Features are introduced in <tt>qmake 4</tt> and have the following characteristics:</p>
<ul>
<li>A feature is either explicitly or implicity loaded using <tt>load()</tt>. For example, <tt>CONFIG+=qtopiadesktop</tt> indicates that <tt>qtopiadesktop.prf</tt> will be loaded if it exists.</li>
<li>A feature is not loaded more than once for each project instance.</li>
<li>Qtopia feature files are located in <tt>$PROJECT_ROOT/features</tt> and <tt>$QTOPIA_DEPOT_PATH/src/build</tt>.</li>
<li><tt>qmake</tt> uses the <tt>QMAKEFEATURES</tt> variable to determine where to search for these directories.</li>
<li>A feature can appear to load itself for example, <tt>default_pre.prf</tt> calls <tt>load(default_pre)</tt>) but what actually happens is that another feature in a later directory is loaded if it exists.<p>The example provided is used because Qtopia's <tt>default_pre.prf</tt> needs to load the Qt <tt>default_pre.prf</tt> file.</p>
</li>
</ul>
<p><b>Note:</b> When adding a new <tt>.prf</tt> file that matches one of the global files, to the project root features directory, be sure to load the global file unless you completely replace its functionality. For example:</p>
<pre>&nbsp;   # $QPEDIR/tests/features/qtopiadesktop.prf
    load(qtopiadesktop) # get the Qtopia one

    # override something that we didn't like</pre>
<p>The following table describes features that can be loaded after a project's <tt>.pro</tt> file . <b>Note:</b> Some of these files are described in more detail later:</p>
<p><table width="100%" align="center" cellpadding="2" cellspacing="1" border="0">
<tr valign="top" bgcolor="#a2c511"><th>Feature</th><th>Description</th></tr>
<tr valign="top" bgcolor="#f0f0f0"><td><tt>common.prf</tt></td><td><ul>
<li>Set defaults (if not already set).</li>
<li>Add the include path to the depend path (so that other places don't need to worry about this).</li>
<li>Strange stuff to help the Qt switchover.</li>
</ul>
</td></tr>
<tr valign="top" bgcolor="#e0e0e0"><td><tt>depends.prf</tt></td><td>Process commands from projects that are dependencies.</td></tr>
<tr valign="top" bgcolor="#f0f0f0"><td><tt>i18n.prf</tt></td><td><ul>
<li>Set up <tt>make lupdate</tt> and <tt>make linstall</tt> rules.</li>
<li>Some of the <a href="buildsystem-user-guide.html#install-helpers">Install Helpers</a> are implemented here.</li>
</ul>
</td></tr>
<tr valign="top" bgcolor="#e0e0e0"><td><tt>installs.prf</tt></td><td>Most of the <a href="buildsystem-user-guide.html#install-helpers">Install Helpers</a> are implemented here.</td></tr>
<tr valign="top" bgcolor="#f0f0f0"><td><tt>packages.prf</tt></td><td>Create installable packages.</td></tr>
<tr valign="top" bgcolor="#e0e0e0"><td><tt>qtopia.prf</tt></td><td>Qtopia-specific config.</td></tr>
<tr valign="top" bgcolor="#f0f0f0"><td><tt>qtopiadesktop.prf</tt></td><td>Qtopia Desktop-specific configuration.</td></tr>
<tr valign="top" bgcolor="#e0e0e0"><td><tt>singleexec.prf</tt></td><td>Set up a <tt>singleexec</tt> build (Qtopia only).</td></tr>
<tr valign="top" bgcolor="#f0f0f0"><td><tt>stub.prf</tt></td><td>Set default values for stub projects.</td></tr>
<tr valign="top" bgcolor="#e0e0e0"><td><tt>subdirs.prf</tt></td><td><ul>
<li>Check <tt>SUBDIRS</tt>.</li>
<li>Partial tree building.</li>
<li>Set up recursive commands (<tt>lupdate, packages, sdk, devsdk, install_target, syncqtopia</tt>).</li>
<li>Smart ordering.</li>
</ul>
</td></tr>
</table></p>
<a name="install-prefixes"></a>
<h2>Install Prefixes</h2>
<p>Items are installed to different locations depending on the edition and platform you are building for.</p>
<p><table align="center" cellpadding="2" cellspacing="1" border="0">
<tr valign="top" bgcolor="#a2c511"><th rowspan="2"></th><th>Qtopia</th><th colspan="3">Qtopia Desktop</th></tr>
<tr valign="top" bgcolor="#a2c511"><th>Linux</th><th>Windows</th><th>Linux</th><th>Mac OS X</th></tr>
<tr valign="top" bgcolor="#f0f0f0"><td>Binaries</td><td><tt>/bin</tt></td><td>/</td><td><tt>/bin</tt></td><td>See note below</td></tr>
<tr valign="top" bgcolor="#e0e0e0"><td>Libraries</td><td><tt>/lib</tt></td><td>/</td><td><tt>/lib</tt></td><td><tt>&lt;bundle&gt;/Frameworks</tt></td></tr>
<tr valign="top" bgcolor="#f0f0f0"><td>Plug-ins</td><td><tt>/plugins</tt></td><td><tt>/plugins</tt></td><td><tt>/qtopiadesktop/plugins</tt></td><td><tt>&lt;bundle&gt;/Resources/plugins</tt></td></tr>
<tr valign="top" bgcolor="#e0e0e0"><td>Resources</td><td>/</td><td>/</td><td><tt>/qtopiadesktop</tt></td><td><tt>&lt;bundle&gt;/Resources</tt></td></tr>
</table></p>
<p><b>Note:</b></p>
<ol type="1">
<li>Resources includes everything that is not an application, library or plug-in.</li>
<li>The situation with binaries on Mac OS X is unique. The binaries are actually located in:<ul>
<li>Qtopia Desktop.app/Contents/MacOS/qtopiadesktop</li>
<li>Qtopia Desktop.app/Resources/assistant.app/Contents/MacOS/assistant</li>
</ul>
</li>
</ol>
<p>As you can see, no locations are common between the supported configurations. The <tt>install_prefix</tt> feature provides the following variables that allow the install path to be set correctly:</p>
<ul>
<li><tt>$$bindir</tt></li>
<li><tt>$$libdir</tt></li>
<li><tt>$$plugdir</tt></li>
<li><tt>$$resdir</tt></li>
</ul>
<p>Using these variables is not strictly required for Qtopia-only projects and there are some situations where you should not use them, including:</p>
<ul>
<li>Automatic installs (documented below) will get these automatically.</li>
<li>Targets that are not part of an install (eg. SDK) should not use these prefixes.</li>
</ul>
<a name="debugging-qmake"></a>
<h2>Debugging qmake</h2>
<p>To display debug messages (including dependency statements) <tt>touch</tt> <tt>$QPEDIR/src/build/debug_on</tt> or <tt>export QMAKE_DEBUG_ON=1</tt>.</p>
<p>To display <tt>qmake</tt> debug run the command: <tt>make qmake-debug</tt>. You can specify more verbosity by running <tt>make qmake-debug D=&quot;-d -d -d&quot;</tt> (more -d's indicates a more verbose debug).</p>
<p>To display when each build system file is processed <tt>touch</tt> <tt>$QPEDIR/src/build/trace_on</tt>. The output has more information than it should but there is no easy way to fix that. The following is an annotated example, showing which parts are relevant:</p>
<pre>&nbsp;   These files are not read by your project.
    Project MESSAGE: .qmake.cache
    Project MESSAGE: default_pre.prf
    Project MESSAGE: functions.prf
    Project MESSAGE: config.prf
    Project MESSAGE: .qmake.cache

    Here is the real starting point that is, the last .qmake.cache before the first functions.prf.
    Project MESSAGE: .qmake.cache
    Project MESSAGE: default_pre.prf
    Project MESSAGE: functions.prf
    Project MESSAGE: config.prf
    Project MESSAGE: datebook.pro
    Project MESSAGE: default_post.prf
    Project MESSAGE: qtopia.prf
    Project MESSAGE: depends.prf

    These files are not read by your project.
    Project MESSAGE: START DEPENDENCIES
    Project MESSAGE: default_pre.prf
    Project MESSAGE: functions.prf
    Project MESSAGE: config.prf
    Project MESSAGE: qtopia.pro
    Project MESSAGE: default_pre.prf
    Project MESSAGE: functions.prf
    Project MESSAGE: config.prf
    Project MESSAGE: qtopiapim.pro
    Project MESSAGE: default_pre.prf
    Project MESSAGE: functions.prf
    Project MESSAGE: config.prf
    Project MESSAGE: quicklauncher.pro
    Project MESSAGE: INDIRECT DEPENDENCIES
    Project MESSAGE: default_pre.prf
    Project MESSAGE: functions.prf
    Project MESSAGE: config.prf
    Project MESSAGE: server.pro
    Project MESSAGE: END DEPENDENCIES

    These files are being read by your project.
    Project MESSAGE: i18n.prf
    Project MESSAGE: installs.prf
    Project MESSAGE: common.prf</pre>
<a name="finding-files-directories-and-paths"></a>
<h2>Finding Files, Directories and Paths</h2>
<p>The following table describes the variables available to help you locate files, directories and paths:</p>
<p><table width="100%" align="center" cellpadding="2" cellspacing="1" border="0">
<tr valign="top" bgcolor="#a2c511"><th>Variable</th><th>Descripition</th></tr>
<tr valign="top" bgcolor="#f0f0f0"><td><tt>SRCDIR</tt></td><td><ul>
<li>The directory containing the application <tt>.pro</tt> file.</li>
<li>This is not available until after <tt>qtopia_project()</tt> has been called.</li>
<li><tt>PWD</tt> can be used from the <tt>.pro</tt> file)</li>
</ul>
</td></tr>
<tr valign="top" bgcolor="#e0e0e0"><td><tt>OUT_PWD</tt></td><td>Directory containing the <tt>Makefile</tt>.</td></tr>
<tr valign="top" bgcolor="#f0f0f0"><td><tt>QPEDIR</tt></td><td>Build tree.</td></tr>
<tr valign="top" bgcolor="#e0e0e0"><td><tt>QTOPIA_DEPOT_PATH</tt></td><td>Source tree.</td></tr>
<tr valign="top" bgcolor="#f0f0f0"><td><tt>PWD</tt></td><td>The directory containing the currently-executing <tt>.pr[iof]</tt> file.<p><b>Note:</b> This will change as each file is read).</p>
</td></tr>
<tr valign="top" bgcolor="#e0e0e0"><td><tt>QTDIR</tt></td><td>Qt or Qtopia Core build tree (depending on what the current project uses).</td></tr>
<tr valign="top" bgcolor="#f0f0f0"><td><tt>QT_DEPOT_PATH</tt></td><td>Qt or Qtopia Core source tree (depending on what the current project uses).</td></tr>
<tr valign="top" bgcolor="#e0e0e0"><td><tt>QTEDIR</tt></td><td>Qtopia Core build tree.</td></tr>
<tr valign="top" bgcolor="#f0f0f0"><td><tt>QTE_DEPOT_PATH</tt></td><td>Qtopia Core source tree.</td></tr>
<tr valign="top" bgcolor="#e0e0e0"><td><tt>DQTDIR</tt></td><td>Qt build tree.</td></tr>
<tr valign="top" bgcolor="#f0f0f0"><td><tt>DQT_DEPOT_PATH</tt></td><td>Qt source tree.</td></tr>
</table></p>
<p><b>Note:</b></p>
<ol type="1">
<li>The build system searches for files relative to <tt>PWD</tt>.</li>
<li><tt>qmake</tt> searches for files in a number of places, generally relative to <tt>SRCDIR</tt>, <tt>OUT_PWD</tt> and each location in <tt>VPATH</tt>.</li>
<li>The Qt and Qtopia Core source trees are the same. The presence of both variables is for legacy purposes only.</li>
</ol>
<a name="style"></a>
<h2>Style</h2>
<p>The following is a guide to style issues when coding:</p>
<ul>
<li>Do not use <tt>for</tt> loops in shell, alternatively use the <tt>qmake for()</tt> function instead. Look at existing files for an example of how to do this.</li>
<li>Do not set <tt>DESTDIR</tt> or <tt>target.path</tt> unless the default values are not acceptable.</li>
<li>Do not set <tt>CONFIG</tt> values such as <tt>qt</tt>, <tt>debug</tt>, <tt>warn</tt>, <tt>release</tt>, <tt>static</tt> unless absolutely neccessary.</li>
<li>Values for <tt>CONFIG</tt> should be lower case, optionally using <b>_</b> to separate words.</li>
<li>Use <tt>$$VAR</tt> where possible. When followed by whitespace or <b>/</b>, you do not need the <b>{}</b> delimiters. However, there are cases where the delimiters are required, for example, <tt>$${VAR}_foo</tt>.</li>
<li>Beware of <i>object notation</i>. Unlike most languages, <tt>qmake</tt> allows <b>.</b> to be part of a variable. For example, <tt>$$FOO.bar</tt> is the same as <tt>$${FOO.bar}</tt>, not <tt>$${FOO}.bar</tt>.</li>
<li>Do not use <tt>$$(FOO)</tt> unless it is absolutely necessary as this will dereference an environment variable at the time the <tt>.pro</tt> file is processed.</li>
<li>Do not use <tt>$(FOO)</tt> unless it is absolutely necessary as this will dereference a <tt>make</tt> variable when <tt>make</tt> is run. <tt>qmake</tt> does not dereference this as an environment variable so files specified using this will not be found.</li>
</ul>
<a name="processing-order"></a>
<h2>Processing Order</h2>
<p>Libraries must be processed before other projects that link to them. When <tt>qmake</tt> processes a library it creates a <tt>.prl</tt> file. When a project links to a library, <tt>qmake</tt> reads the <tt>.prl</tt> file. If the <tt>.prf</tt> file does not exist, <tt>qmake</tt> will guess the contents which can cause problems. The dependency system should be enough to prevent this from happening but to be sure, <tt>configure</tt> runs <tt>make syncqtopia</tt> to ensure all library directories are processed.</p>
<p>The build system installs headers based on install rules defined in <tt>.pro</tt> files. This means that projects cannot be built before the headers they depend on are installed. The dependency system should be enough to prevent this from happening but to be sure, <tt>configure</tt> runs <tt>make syncqtopia</tt> which causes the include directory to be set up.</p>
<a name="project-roots"></a>
<h2>Project Roots</h2>
<p>The following files are expected (though optional) for each project root:</p>
<p><table width="100%" align="center" cellpadding="2" cellspacing="1" border="0">
<tr valign="top" bgcolor="#a2c511"><th>File</th><th>Description</th></tr>
<tr valign="top" bgcolor="#f0f0f0"><td><tt>.qmake.cache</tt></td><td>Generated by <tt>qtopiamake</tt>.</td></tr>
<tr valign="top" bgcolor="#e0e0e0"><td><tt>tree_config.pri</tt></td><td>Set up initial configuration and additional keywords.</td></tr>
<tr valign="top" bgcolor="#f0f0f0"><td><tt>features/implicit_deps.prf</tt></td><td>Set up implicit dependencies.</td></tr>
</table></p>
<a name="building-qt-qtopia-core"></a>
<h2>Building Qt/Qtopia Core</h2>
<p>Qt/Qtopia Core is built by running <tt>make</tt> in the following locations:</p>
<ul>
<li><tt>src/libraries/qt</tt></li>
<li><tt>src/tools/qt</tt></li>
<li><tt>src/plugins/qt</tt></li>
<li><tt>src/libraries/qtopiacore</tt></li>
<li><tt>src/tools/qtopiacore</tt></li>
<li><tt>src/plugins/qtopiacore</tt></li>
</ul>
<p><b>Note:</b> Do not build Qt/Qtopia core by enterin <tt>$QPEDIR/qtopiacore/[host|target]</tt>.</p>
<a name="command-redirection"></a>
<h2>Command Redirection</h2>
<p>To override <tt>qmake</tt>-generated targets name them specially. The exception to this is the <tt>all</tt> target. The structure is <tt>redirect_&lt;target&gt;</tt> for example:</p>
<pre>&nbsp;   redirect_clean.commands=@echo overriding the clean target
    QMAKE_EXTRA_TARGETS+=redirect_clean</pre>
<p>The <tt>all</tt> target cannot be overridden but you can trigger a command to run at that time. This is mostly useful for stub projects as they do not build anything. For example:</p>
<pre>&nbsp;   redirect_all.commands=@echo redirect_all
    ALL_DEPS+=redirect_all</pre>
<p>There are some commands cannot be overriden:</p>
<ul>
<li><tt>[first_]syncqtopia</tt> (libraries only)</li>
<li><tt>regenerate/qmake</tt> (you can hook onto this event though, see below)</li>
</ul>
<pre>&nbsp;   mytarget.commands=@echo regenerating
    QMAKE_EXTRA_TARGETS+=mytarget
    regenerate.depends+=mytarget</pre>
<a name="how-do-i"></a>
<h2>How Do I ...</h2>
<a name="add-a-custom-compiler"></a>
<h3>... add a custom compiler?</h3>
<p>The following is an example to compile some Flex (Lex) and Bison (YACC) files. These examples are useful because <tt>qmake</tt>'s built-in support for these compilers is limited.</p>
<p><b>Note:</b> This solution can only support one Flex and one Bison source file per project.</p>
<pre>&nbsp;   FLEX_SOURCES=lexer.l
    BISON_SOURCES=parser.y

    flex.commands=flex -o${QMAKE_FILE_OUT} ${QMAKE_FILE_IN}
    flex.output=$$OUT_PWD/${QMAKE_FILE_BASE}.c
    flex.input=FLEX_SOURCES
    flex.variable_out=SOURCES
    flex.name=flex ${QMAKE_FILE_IN}
    # qmake can't parse lexer.l to see this dependency
    flex.depends=parser.h
    QMAKE_EXTRA_COMPILERS+=flex

    bisonsource.commands=bison -d -o${QMAKE_FILE_OUT} ${QMAKE_FILE_IN}
    bisonsource.output=$$OUT_PWD/${QMAKE_FILE_BASE}.c
    bisonsource.input=BISON_SOURCES
    bisonsource.variable_out=SOURCES
    bisonsource.name=bisonsource ${QMAKE_FILE_IN}
    QMAKE_EXTRA_COMPILERS+=bisonsource

    # This dummy entry is required so that qmake handles the header correctly
    bisonheader.commands=@true
    bisonheader.output=$$OUT_PWD/${QMAKE_FILE_BASE}.h
    bisonheader.input=BISON_SOURCES
    bisonheader.variable_out=HEADERS
    bisonheader.name=bisonheader ${QMAKE_FILE_IN}
    # this dependency is required so that files that depend on parser.h are processed after Bison is run
    bisonheader.depends=parser.c
    QMAKE_EXTRA_COMPILERS+=bisonheader</pre>
<a name="use-install-rules-at-other-times"></a>
<h3>... use install rules at other times?</h3>
<p>You need to set the following CONFIG:</p>
<pre>&nbsp;   foo.CONFIG=no_default_install</pre>
<p>This makes the rule exist but does not force the install target depend on it. For example, the <a href="buildsystem-reference.html#headers">headers hint</a> uses this so that the rules for setting up the <tt>include</tt> directory do not trigger when you run <tt>make install</tt>.</p>
<a name="run-some-commands-before-the-target-is-built"></a>
<h3>... run some commands before the target is built?</h3>
<p>It is somewhat tricky to get your code to run before the target is built. The easiest way is to create a compiler that outputs to the <tt>HEADERS</tt> or <tt>SOURCES</tt> variable.</p>
<pre>&nbsp;   # This crap is needed to generate datasets.h
    GENERATOR=make_test_data.pl
    dataset.commands=$$COMMAND_HEADER\
        $$PWD/make_test_data.pl ${QMAKE_FILE_OUT}
    dataset.output=$$OUT_PWD/datasets.h
    dataset.input=GENERATOR
    dataset.variable_out=HEADERS
    dataset.name=Generate ${QMAKE_FILE_OUT}
    QMAKE_EXTRA_COMPILERS+=dataset</pre>
<p>You need to <tt>#include</tt> the generated file in some other file to force this to run first.</p>
<a name="run-some-commands-after-the-target-is-built"></a>
<h3>... run some commands after the target is built?</h3>
<p>You can force your target to run after the target is built by depending on it. <b>Note:</b> The use of the <tt>Makefile</tt> variable.</p>
<pre>&nbsp;   foo.depends+=$(TARGET)</pre>
<a name="make-my-project-get-processed-last"></a>
<h3>... make my project get processed last?</h3>
<p>You can use <a href="buildsystem-reference.html#depends">fake dependencies</a> to do this. However, <tt>src/build/extra</tt> already does this so you can just depend on it or put your commands in there.</p>
<p /><address><hr /><div align="center">
<table width="100%" cellspacing="0" border="0"><tr class="address">
<td width="30%">Copyright &copy; 2007 <a href="trolltech.html">Trolltech</a></td>
<td width="40%" align="center"><a href="trademarks.html">Trademarks</a></td>
<td width="30%" align="right"><div align="right">Qtopia 4.2.2</div></td>
</tr></table></div></address></body>
</html>
