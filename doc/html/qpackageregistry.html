<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html
    PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>QPackageRegistry Class Reference</title>
  <link href="classic.css" rel="stylesheet" type="text/css" />
</head>
<body>
<table border="0" cellpadding="0" cellspacing="0" width="100%">
<tr>
<td align="left" valign="top" width="32"><img src="images/qpelogo.png" align="left" width="32" height="32" border="0" /></td>
<td width="1">&nbsp;&nbsp;</td><td class="postheader" valign="center"><a href="index.html"><font color="#004faf">Home</font></a>&nbsp;&middot; <a href="classes.html"><font color="#004faf">All&nbsp;Classes</font></a>&nbsp;&middot; <a href="groups.html"><font color="#004faf">Grouped Classes</font></a>&nbsp;&middot; <a href="annotated.html"><font color="#004faf">Annotated</font></a>&nbsp;&middot; <a href="functions.html"><font color="#004faf">Functions</font></a></td>
<td align="right" valign="top" width="230"><img src="images/trolltech-logo.png" align="right" width="203" height="32" border="0" /></td></tr></table><h1 align="center">QPackageRegistry Class Reference</h1>
<p>The QPackageRegistry class provides a mechanism for managing software installed on the qtopia device <a href="#details">More...</a></p>
<pre>    #include &lt;QPackageRegistry&gt;</pre><p>Inherits <a href="./qobject.html">QObject</a>.</p>
<ul>
<li><a href="qpackageregistry-members.html">List of all members, including inherited members</a></li>
</ul>
<a name="public-types"></a>
<h3>Public Types</h3>
<ul>
<li><div class="fn"/>enum <b><a href="qpackageregistry.html#RegistryFile-enum">RegistryFile</a></b> { Keyfile, Manifest, KeyfileSequence, Installs, Policy }</li>
</ul>
<a name="public-functions"></a>
<h3>Public Functions</h3>
<ul>
<li><div class="fn"/><b><a href="qpackageregistry.html#QPackageRegistry">QPackageRegistry</a></b> ()</li>
<li><div class="fn"/>virtual <b><a href="qpackageregistry.html#dtor.QPackageRegistry">~QPackageRegistry</a></b> ()</li>
<li><div class="fn"/>int <b><a href="qpackageregistry.html#bootstrap">bootstrap</a></b> ( const QString &amp; <i>installRoot</i> )</li>
<li><div class="fn"/>const unsigned char * <b><a href="qpackageregistry.html#getClientKey">getClientKey</a></b> ( unsigned char <i>progId</i> )</li>
<li><div class="fn"/>void <b><a href="qpackageregistry.html#initProgramInfo">initProgramInfo</a></b> ( SxeProgramInfo &amp; <i>pi</i> )</li>
<li><div class="fn"/>bool <b><a href="qpackageregistry.html#isInstalledProgram">isInstalledProgram</a></b> ( QTransportAuth::Data &amp; <i>connectionData</i> )&nbsp;&nbsp;<tt> (deprecated)</tt></li>
<li><div class="fn"/>virtual QString <b><a href="qpackageregistry.html#sxeConfPath">sxeConfPath</a></b> () const</li>
<li><div class="fn"/>bool <b><a href="qpackageregistry.html#unregisterPackageBinaries">unregisterPackageBinaries</a></b> ( const QString &amp; <i>packagePath</i> )</li>
</ul>
<ul>
<li><div class="fn"/>29 public functions inherited from <a href="./qobject.htmlqobject.html#public-functions">QObject</a></li>
</ul>
<a name="public-slots"></a>
<h3>Public Slots</h3>
<ul>
<li><div class="fn"/>void <b><a href="qpackageregistry.html#lockManifest">lockManifest</a></b> ( bool &amp; <i>success</i> )</li>
<li><div class="fn"/>void <b><a href="qpackageregistry.html#registerBinary">registerBinary</a></b> ( SxeProgramInfo &amp; <i>pi</i> )</li>
<li><div class="fn"/>void <b><a href="qpackageregistry.html#unlockManifest">unlockManifest</a></b> ()</li>
</ul>
<ul>
<li><div class="fn"/>1 public slot inherited from <a href="./qobject.htmlqobject.html#public-slots">QObject</a></li>
</ul>
<a name="static-public-members"></a>
<h3>Static Public Members</h3>
<ul>
<li><div class="fn"/>const QString <b><a href="qpackageregistry.html#binInstallPath-var">binInstallPath</a></b></li>
<li><div class="fn"/>QPackageRegistry * <b><a href="qpackageregistry.html#getInstance">getInstance</a></b> ()</li>
<li><div class="fn"/>const QString <b><a href="qpackageregistry.html#installsFileName-var">installsFileName</a></b></li>
<li><div class="fn"/>const QString <b><a href="qpackageregistry.html#manifestFileName-var">manifestFileName</a></b></li>
<li><div class="fn"/>const QString <b><a href="qpackageregistry.html#profilesFileName-var">profilesFileName</a></b></li>
<li><div class="fn"/>const QString <b><a href="qpackageregistry.html#qlLibInstallPath-var">qlLibInstallPath</a></b></li>
</ul>
<ul>
<li><div class="fn"/>4 static public members inherited from <a href="./qobject.htmlqobject.html#static-public-members">QObject</a></li>
</ul>
<h3>Additional Inherited Members</h3>
<ul>
<li><div class="fn"/>1 property inherited from <a href="./qobject.htmlqobject.html#properties">QObject</a></li>
<li><div class="fn"/>1 signal inherited from <a href="./qobject.htmlqobject.html#signals">QObject</a></li>
<li><div class="fn"/>1 public type inherited from <a href="./qobject.htmlqobject.html#public-variables">QObject</a></li>
<li><div class="fn"/>7 protected functions inherited from <a href="./qobject.htmlqobject.html#protected-functions">QObject</a></li>
<li><div class="fn"/>2 protected variables inherited from <a href="./qobject.htmlqobject.html#protected-variables">QObject</a></li>
</ul>
<a name="details"></a>
<hr />
<h2>Detailed Description</h2>
<p>The QPackageRegistry class provides a mechanism for managing software installed on the qtopia device</p>
<p>QPackageRegistry provides several methods for managing the database files which track installed software as part of the <a href="sxe.html">Safe Execution Environment (SXE)</a>.</p>
<p>When downloaded software is installed the <a href="sxe-pkgmgr.html">SXE Software Installer</a> calls methods here, to register the software with SXE and thus enable SXE for those applications, and to allow later uninstallation.</p>
<a name="program-management"></a>
<h3>Program Management</h3>
<p>All programs installed on the device are assigned a <b>program id</b>. A program will often consist of a number of binaries providing related functionality, for example a game may contain a small server, a gui client and a map editor which make up the package. In Qtopia, binaries which provide similar functionality and require the same security domain, are grouped into one program id.</p>
<p>The program id is always written into the binary at install time, along with a secret key.</p>
<p>For <u>Qtopia programs</u> when the image is created the sxe_installer is run which calls the packageRegistry in bootstrap mode to setup the database files and install the program id, and keys for those Qtopia programs. This occurs prior to shipping &amp; delivery of the Qtopia device.</p>
<p>For <u>downloaded programs</u> the package installer will call the <a href="qpackageregistry.html#registerBinary">registerBinary</a>() method to install the program id. This occurs during normal runtime of the Qtopia device.</p>
<p>When the program id and key is created and installed, these are recorded in the <b>Keyfile</b>, and the <b>Sequence</b> file is used to track issue of new program ids.</p>
<p>Note that rekeying and key time-outs are no longer used. This mechanism has been superseded by the /proc/lids/keys method.</p>
<p>See <a href="#key-file-change-notes">Key File Change Notes</a> for important details on these changes.</p>
<a name="binary-management"></a>
<h3>Binary Management</h3>
<p>Installed binaries by inode &amp; device id are mapped to their program id in the <b>Manifest</b> file. Many binaries can map to a single program id.</p>
<p>This format is designed for fast lookup of programs. Given a binary's path, eg from /proc/&lt;pid&gt;/exe, the inode and device id could be obtained, and the correct program id read from this file.</p>
<p>The manifest file is only accessed by the packagemanager and the server (qpe). Its contents are not as sensitive as the keyfile, but should not be accessible by other processes.</p>
<p>If the string version of the paths for a binary are needed based on install id, they can be looked up in the <b>Installs</b> file. This is required mainly for uninstallation of packages, but could be used for reporting and other purposes.</p>
<p>The manifest and installs files are accessed by the packagemanager and the server (qpe). Their contents are not as sensitive as the keyfile, but should not be accessible by other processes.</p>
<a name="sxe-package-database-files"></a>
<h3>SXE Package Database Files</h3>
<p>As discussed in the previous two sections, QPackageRegistry tracks several files which comprise the SXE database. This table summarizes these files and their format:</p>
<p><table align="center" cellpadding="2" cellspacing="1" border="0">
<thead><tr valign="top" class="qt-style"><th>Keyfile</th><th>Sequence</th><th>Manifest</th><th>Installs</th></tr></thead>
<tr valign="top" class="odd"><td>$QPEDIR/etc/keyfile</td><td>$QPEDIR/etc/keyfile.sequence</td><td>$QPEDIR/etc/manifest</td><td>$QPEDIR/etc/installs</td></tr>
<tr valign="top" class="even"><td colspan="4" rowspan=" 1">Pseudo-code for binary file data record formats: See <tt>$QT_SOURCE_PATH/src/gui/embedded/qtransportauth_qws_p.h</tt> for concrete details. <tt>usr_key_entry</tt> is from the kernel file include/linux/lidsext.h and is duplicated in the qtransportauth_qws_p.h</td></tr>
<tr valign="top" class="odd"><td><pre>    struct usr_key_entry
        char key[QSXE_KEY_LEN];
        ino_t ino;              <span class="comment">//</span> typically 4 bytes
        dev_t dev;              <span class="comment">//</span> typically 8 bytes</pre>
</td><td><pre>    struct AuthRecord
      16 byte key
      program id
      change time   <span class="comment">//</span> deprecated</pre>
</td><td><pre>    struct IdBlock
        quint64 inode
        quint64 device
        unsigned char progId
        unsigned short installId
        unsigned int keyOffset
        qint64 install_time</pre>
</td><td><pre>    install record
        install id
        &quot;:&quot;
        path</pre>
</td></tr>
<tr valign="top" class="even"><td>Contains the mapping between keys and files on disk.<p>When the kernel contains the LIDS MAC Trolltech patch the key file is implemented as the kernel /proc pseudo-file /proc/lids/keys.</p>
<p>In this case this keyfile on disk storage is ignored.</p>
</td><td>This file is used simply to ensure a sequence of program id numbers.<p>For historical and compatibility reasons, the first key issued with a number and the time are also recorded in this file.</p>
</td><td>Map Installed binaries by inode &amp; device id to their program id - many binaries can map to a single program id. Records an install id for each binary.</td><td>Map install id to installed path of the binary.<p>This is required mainly for uninstallation of packages.</p>
</td></tr>
</table></p>
<p>To query these files after a <tt>make install</tt> use the tool <tt>$QTOPIA_SOURCE_PATH/scripts/dumpsec.pl</tt></p>
<a name="key-file-change-notes"></a>
<h3>Key File Change Notes</h3>
<p>Both the proc pseudo file and the disk file have the same format, and if the /proc/lids/keys file is not present, disk files are used instead.</p>
<p>The <tt>struct usr_key_entry</tt> is defined in SXE kernel patch file include/linux/lidsif.h</p>
<p><tt>struct usr_key_entry</tt> is the (new) data record format for the key file superseding the format used in Qtopia 4.1</p>
<p>The key file is (now) either <tt>/proc/lids/keys</tt> (and the per-process keys in <tt>/proc/&lt;pid&gt;/lids_key</tt> ) OR for desktop/development ONLY (not for production) it is <tt>$QPEDIR/etc/keyfile</tt></p>
<p>The key file maps keys to files.</p>
<p>File are identified by inode and device numbers, not paths.</p>
<p>(See the &quot;installs&quot; file for path to inode/device mapping)</p>
<p>Disk keyfiles are to allow desktop development and testing only, since on desktop development machines the kernel patch will typically not be installed.</p>
<p><b>It is not supported on the device to operate without /proc/lids/keys</b></p>
<p>Where binary files are writeable (all downloaded programs must be writeable) the key is embedded in the binary at install time.</p>
<p>In the development and testing case, the embedded key is used by the binary to authenticate itself to the server.</p>
<p>When the kernel contains the LIDS MAC Trolltech patch the binary reads its key from the /proc pseudo-file /proc/self/lids_key.</p>
<p>See also <a href="qpackageregistry.html#RegistryFile-enum">RegistryFile</a>.</p>
<hr />
<h2>Member Type Documentation</h2>
<h3 class="fn"><a name="RegistryFile-enum"></a>enum QPackageRegistry::RegistryFile</h3>
<p>This enum specifies one of the registry files</p>
<p><table border="1" cellpadding="2" cellspacing="1" width="100%">
<tr><th width="25%">Constant</th><th width="15%">Value</th><th width="60%">Description</th></tr>
<tr><td valign="top"><tt>QPackageRegistry::Keyfile</tt></td><td align="center" valign="top"><tt>0</tt></td><td valign="top">keyfile</td></tr>
<tr><td valign="top"><tt>QPackageRegistry::Manifest</tt></td><td align="center" valign="top"><tt>2</tt></td><td valign="top">manifest keyfile</td></tr>
<tr><td valign="top"><tt>QPackageRegistry::KeyfileSequence</tt></td><td align="center" valign="top"><tt>1</tt></td><td valign="top">key file</td></tr>
<tr><td valign="top"><tt>QPackageRegistry::Installs</tt></td><td align="center" valign="top"><tt>3</tt></td><td valign="top">installs file</td></tr>
<tr><td valign="top"><tt>QPackageRegistry::Policy</tt></td><td align="center" valign="top"><tt>4</tt></td><td valign="top">policy file</td></tr>
</table></p>
<hr />
<h2>Member Function Documentation</h2>
<h3 class="fn"><a name="QPackageRegistry"></a>QPackageRegistry::QPackageRegistry ()</h3>
<p>Construct new <a href="qpackageregistry.html">QPackageRegistry</a> object</p>
<p>Do not use this method, instead call the instance method <a href="qpackageregistry.html#getInstance">getInstance</a>()</p>
<p>See also <a href="qpackageregistry.html#getInstance">getInstance</a>().</p>
<h3 class="fn"><a name="dtor.QPackageRegistry"></a>QPackageRegistry::~QPackageRegistry ()&nbsp;&nbsp;<tt> [virtual]</tt></h3>
<p>Destroy the <a href="qpackageregistry.html">QPackageRegistry</a> object</p>
<h3 class="fn"><a name="bootstrap"></a>int QPackageRegistry::bootstrap ( const <a href="./qstring.html">QString</a> &amp; <i>installRoot</i> )</h3>
<p>Bootstrap the qtopia image with sxe control files.</p>
<p>Creates (or truncates) new empty SXE control files, ready to be updated by the scanner. If the <i>installRoot</i> already contains non-empty files then it will refuse to overwrite them.</p>
<p>The return code of this is used as a unix exec return code, ie 0 is success non-zero is failure.</p>
<h3 class="fn"><a name="getClientKey"></a>const unsigned char * QPackageRegistry::getClientKey ( unsigned char <i>progId</i> )</h3>
<p>Return the key associated the specified program id <i>progId</i>.</p>
<p>As a host binary sxe_installer doesnt have access to this method in qtransportauth_qws.cpp, so reimplement it here.</p>
<p>In the SXE installer case assume there is a one-to-one mapping from keys to progId's since the installer ensures that.</p>
<h3 class="fn"><a name="getInstance"></a>QPackageRegistry * QPackageRegistry::getInstance ()&nbsp;&nbsp;<tt> [static]</tt></h3>
<p>Return a singleton instance of the <a href="qpackageregistry.html">QPackageRegistry</a> object for this process.</p>
<h3 class="fn"><a name="initProgramInfo"></a>void QPackageRegistry::initProgramInfo ( <a href="sxeprograminfo.html">SxeProgramInfo</a> &amp; <i>pi</i> )</h3>
<p>Initialise an <a href="sxeprograminfo.html">SxeProgramInfo</a> <i>pi</i> which can then be used to register a sequence of same-domain binaries.</p>
<p>A new key and a new program id is created and stored in <i>pi</i>. The other fields are unchanged.</p>
<p>The keyfile.sequence file is used to track and issue new program id numbers.</p>
<h3 class="fn"><a name="isInstalledProgram"></a>bool QPackageRegistry::isInstalledProgram ( QTransportAuth::Data &amp; <i>connectionData</i> )</h3>
<p>This function is deprecated.</p>
<p>Return true if the <i>connectionData</i> connection is from an installed program, ie not one which is part of the base software.</p>
<p>The program is installed software if it is installed in <a href="qtopia.html#packagePath">Qtopia::packagePath</a>()</p>
<h3 class="fn"><a name="lockManifest"></a>void QPackageRegistry::lockManifest ( bool &amp; <i>success</i> )&nbsp;&nbsp;<tt> [slot]</tt></h3>
<p>Obtain a <a href="qtopia.html#lockFile">Qtopia::lockFile</a>() on the manifest file. This represents locking the <a href="qpackageregistry.html">QPackageRegistry</a> database system to allow write operations to be done by this process.</p>
<p>If successfully locked, the method sets <i>success</i> to true; otherwise it sets it to false.</p>
<p>Call this method to obtain the lock before performing any write operations to the SXE database system.</p>
<p>This should be matched by a call to <a href="qpackageregistry.html#unlockManifest">unlockManifest</a>()</p>
<p>See also <a href="qpackageregistry.html#unlockManifest">unlockManifest</a>().</p>
<h3 class="fn"><a name="registerBinary"></a>void QPackageRegistry::registerBinary ( <a href="sxeprograminfo.html">SxeProgramInfo</a> &amp; <i>pi</i> )&nbsp;&nbsp;<tt> [slot]</tt></h3>
<p>Register a qtopia binary with the SXE system. The path to the binary is:</p>
<p><tt>pi.absolutePath()</tt></p>
<p>where the <a href="sxeprograminfo.html">SxeProgramInfo</a> <i>pi</i> contains all the information about the binary.</p>
<p>Note that binaries with the same domain (SXE policy profile) and binaries from the same package are coalesced into the same Program Id, and thus use the same secret key.</p>
<p>The <a href="sxeprograminfo.html">SxeProgramInfo</a> <i>pi</i> if uninitialised is modified by creating a new random key and program id. The id and key fields if initialised are used to register the binary.</p>
<p>See also <a href="sxeprograminfo.html">SxeProgramInfo</a>.</p>
<h3 class="fn"><a name="sxeConfPath"></a><a href="./qstring.html">QString</a> QPackageRegistry::sxeConfPath () const&nbsp;&nbsp;<tt> [virtual]</tt></h3>
<p>Return the authoritative path for where the SXE database files, such as installs, and manifest, are stored.</p>
<p>The directory must be writeable.</p>
<p>Current implementation is simply <a href="qtopia.html#qtopiaDir">Qtopia::qtopiaDir</a>() + &quot;etc&quot;</p>
<h3 class="fn"><a name="unlockManifest"></a>void QPackageRegistry::unlockManifest ()&nbsp;&nbsp;<tt> [slot]</tt></h3>
<p>Release the lock on the manifest file.</p>
<p>See also <a href="qpackageregistry.html#lockManifest">lockManifest</a>().</p>
<h3 class="fn"><a name="unregisterPackageBinaries"></a>bool QPackageRegistry::unregisterPackageBinaries ( const <a href="./qstring.html">QString</a> &amp; <i>packagePath</i> )</h3>
<p>Unregisters a package's binaries from the SXE system for the given <i>packagePath</i></p>
<p>returns true if the removal of the registration was successful; otherwise returns false</p>
<hr />
<h2>Member Variable Documentation</h2>
<h3 class="fn"><a name="binInstallPath-var"></a>const <a href="./qstring.html">QString</a> QPackageRegistry::binInstallPath</h3>
<p>returns the <a href="./qstring.html">QString</a> name of the <b>relative</b> <i>binary path</i>, where SXE controlled executables are installed. Concatenate this with paths from installPaths() to find full paths which may contain binaries.</p>
<p>See also <a href="qtopia.html#installPaths">Qtopia::installPaths</a>().</p>
<h3 class="fn"><a name="installsFileName-var"></a>const <a href="./qstring.html">QString</a> QPackageRegistry::installsFileName</h3>
<p>returns the <a href="./qstring.html">QString</a> name of the <i>installs file</i>, part of the SXE database</p>
<p>See also <a href="qpackageregistry.html#sxeConfPath">sxeConfPath</a>().</p>
<h3 class="fn"><a name="manifestFileName-var"></a>const <a href="./qstring.html">QString</a> QPackageRegistry::manifestFileName</h3>
<p>returns the <a href="./qstring.html">QString</a> name of the <i>manifest file</i>, part of the SXE database</p>
<p>See also <a href="qpackageregistry.html#sxeConfPath">sxeConfPath</a>().</p>
<h3 class="fn"><a name="profilesFileName-var"></a>const <a href="./qstring.html">QString</a> QPackageRegistry::profilesFileName</h3>
<p>returns the <a href="./qstring.html">QString</a> name of the <i>profiles file</i>, part of the SXE database</p>
<p>See also <a href="qpackageregistry.html#sxeConfPath">sxeConfPath</a>().</p>
<h3 class="fn"><a name="qlLibInstallPath-var"></a>const <a href="./qstring.html">QString</a> QPackageRegistry::qlLibInstallPath</h3>
<p>returns the <a href="./qstring.html">QString</a> name of the <b>relative</b> <i>quicklaunch binary path</i>, where SXE controlled quicklaunched executables are installed. Concatenate this with paths from installPaths() to find full paths which may contain <tt>.so</tt> files.</p>
<p>See also <a href="qtopia.html#installPaths">Qtopia::installPaths</a>().</p>
<p /><address><hr /><div align="center">
<table width="100%" cellspacing="0" border="0"><tr class="address">
<td align="left">Copyright &copy; 2008 <a href="trolltech.html">Trolltech</a></td>
<td align="center"><a href="trademarks.html">Trademarks</a></td>
<td align="right"><div align="right">Qtopia 4.3.2</div></td>
</tr></table></div></address></body>
</html>
