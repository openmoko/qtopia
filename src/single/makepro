#!/usr/bin/perl

use File::Find;

$smallbuild = 0;

%build = map { ($_,1) }
( !$smallbuild ? (
    "solitaire", "embeddedkonsole", "parashoot",
    "wordgame", "filebrowser", "snake",
) : (),
(
    "library",
    "taskbar",
    "addressbook",
    "calculator",
    "calibrate",
    "citytime",
    "clock",
    "datebook",
    "helpbrowser",
    "launcher",
    "minesweep",
    "appearance",
    "systemtime",
    "sysinfo",
    "tetrix",
    "textedit",
    "todo",
    "clockapplet",
    "handwriting",
    "keyboard",
    "pickboard",
    "mpegplayer",
    "libmad",
    "wavplugin"
));

open PRO, ">single.pro";
print PRO
"# Generated by makepro
TEMPLATE	= app
CONFIG		= qt warn_on release

# qt/2.2 or qt/main?
#CONFIG += qt3

DEFINES		+= SINGLE_APP
DEFINES		+= QT_NO_COMPONENT
DEFINES         += QT_HAS_OK_IN_TITLEBAR
DEFINES         += USE_MULTILINEEDIT
DEFINES		+= FPM_64BIT 
qt3:DEFINES     -= USE_MULTILINEEDIT

#DEPENDPATH    += \$(QTDIR)/include

SOURCES += ../taskbar/main.cpp
";

if ( $smallbuild ) {
print PRO
"DEFINES += QT_QPE_SMALL_BUILD
";
} else {
# print PRO
# "LIBS += -L../plugins/codecs -lmpeg3plugin
# ";
}

@dirs=();
find sub {
    if ( /(.*)\.pro$/ && $build{$1}) {
	$proj = $File::Find::dir;
	push @dirs, $proj;
    }
}, '..';


for $d ( @dirs ) {
    $proj = $d; $proj =~ s|.*/||;
    next if ! -f "$d/$proj.pro";
    next if $d =~ /palmtopcenter/;
    next if $d =~ /desktop/;
    print PRO "INCLUDEPATH    += $d\n";
    print PRO "DEPENDPATH    += $d\n";
    opendir D, "$d";
    for ( sort readdir D ) {
	next if /^moc_/;
	next if /^qlibrary/;
	next if $_ eq "main.cpp";
	if ( /\.cpp$/ || /\.[ch]$/ ) {
	    open F, "$d/$_";
	    $t=<F>;
	    $t=<F>;
	    next if $t =~ / generated /;
	}
	$qualifier = /inserttable|qrichtext|qtextedit|qspellchecker/ ? "qt3:" : "";
	print PRO $qualifier,"SOURCES += $d/$_\n" if /\.cpp$/ || /\.c$/;
	print PRO $qualifier,"HEADERS += $d/$_\n" if /\.h$/;
	print PRO $qualifier,"INTERFACES += $d/$_\n" if /\.ui$/;
    }
}

print PRO "TARGET		= qpe\n";
